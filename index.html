import { useMemo, useState } from "react";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetDescription,
} from "@/components/ui/sheet";
import { Separator } from "@/components/ui/separator";
import { ChevronRight, Search, User2, Calendar, IndianRupee, Percent } from "lucide-react";

// --- Types
export type LoanStatus = "Approved" | "Rejected" | "On Hold";

export type Loan = {
  id: string;
  borrower: string;
  amount: number; // in INR
  apr: number; // as percent
  status: LoanStatus;
  updatedAt: string; // ISO date
  product?: string;
  purpose?: string;
  termMonths?: number;
  notes?: string;
};

// --- Demo Data (replace with your API later)
const DEMO_LOANS: Loan[] = [
  {
    id: "LN-10027",
    borrower: "Rahul Sharma",
    amount: 1250000,
    apr: 11.75,
    status: "Approved",
    updatedAt: "2025-10-14",
    product: "Home Loan",
    purpose: "Purchase",
    termMonths: 240,
    notes: "Pre-approved subject to property valuation.",
  },
  {
    id: "LN-10028",
    borrower: "Priya Natarajan",
    amount: 350000,
    apr: 16.2,
    status: "On Hold",
    updatedAt: "2025-10-15",
    product: "Personal Loan",
    purpose: "Medical",
    termMonths: 48,
    notes: "Awaiting latest bank statements.",
  },
  {
    id: "LN-10029",
    borrower: "Ankit Verma",
    amount: 890000,
    apr: 13.5,
    status: "Rejected",
    updatedAt: "2025-10-09",
    product: "Auto Loan",
    purpose: "New Car",
    termMonths: 60,
    notes: "Credit score below minimum threshold.",
  },
  {
    id: "LN-10030",
    borrower: "Sowmya Krishnan",
    amount: 2100000,
    apr: 10.9,
    status: "Approved",
    updatedAt: "2025-10-18",
    product: "Home Loan",
    purpose: "Refinance",
    termMonths: 180,
    notes: "Offer valid for 14 days.",
  },
  {
    id: "LN-10031",
    borrower: "Vikram Singh",
    amount: 560000,
    apr: 15.0,
    status: "On Hold",
    updatedAt: "2025-10-19",
    product: "Business Loan",
    purpose: "Working Capital",
    termMonths: 36,
    notes: "KYC re-verification in progress.",
  },
];

// --- Helpers
function formatINR(n: number) {
  return new Intl.NumberFormat("en-IN", {
    style: "currency",
    currency: "INR",
    maximumFractionDigits: 0,
  }).format(n);
}

function StatusBadge({ status }: { status: LoanStatus }) {
  const styles: Record<LoanStatus, string> = {
    Approved:
      "bg-emerald-50 text-emerald-700 ring-1 ring-inset ring-emerald-200",
    Rejected:
      "bg-rose-50 text-rose-700 ring-1 ring-inset ring-rose-200",
    "On Hold":
      "bg-amber-50 text-amber-700 ring-1 ring-inset ring-amber-200",
  };
  return (
    <Badge className={`rounded-full px-3 py-1 text-xs font-medium ${styles[status]}`}>{status}</Badge>
  );
}

function InfoRow({ label, value, icon }: { label: string; value?: string | number; icon?: JSX.Element }) {
  return (
    <div className="flex items-center justify-between py-2 text-sm">
      <div className="flex items-center gap-2 text-muted-foreground">
        {icon}
        <span>{label}</span>
      </div>
      <div className="font-medium text-right">{value ?? "—"}</div>
    </div>
  );
}

// --- Main Component
export default function LoanDashboard() {
  const [query, setQuery] = useState("");
  const [statusFilter, setStatusFilter] = useState<"All" | LoanStatus>("All");
  const [selected, setSelected] = useState<Loan | null>(null);

  const loans = DEMO_LOANS;

  const counts = useMemo(() => {
    return loans.reduce(
      (acc, l) => {
        acc.All += 1;
        acc[l.status] += 1 as number;
        return acc;
      },
      { All: 0, Approved: 0, Rejected: 0, "On Hold": 0 } as Record<"All" | LoanStatus, number>
    );
  }, [loans]);

  const filtered = useMemo(() => {
    return loans
      .filter((l) => (statusFilter === "All" ? true : l.status === statusFilter))
      .filter((l) =>
        [l.id, l.borrower].some((x) => x.toLowerCase().includes(query.trim().toLowerCase()))
      )
      .sort((a, b) => b.updatedAt.localeCompare(a.updatedAt));
  }, [loans, query, statusFilter]);

  return (
    <div className="min-h-screen w-full bg-gradient-to-b from-slate-50 to-white p-6 md:p-10">
      <div className="mx-auto max-w-6xl">
        {/* Header */}
        <div className="mb-6 flex flex-col items-start justify-between gap-4 md:mb-8 md:flex-row md:items-center">
          <div>
            <h1 className="text-2xl font-semibold tracking-tight md:text-3xl">Loan Pipeline</h1>
            <p className="text-sm text-muted-foreground">Quickly scan loans by milestone and open details in a click.</p>
          </div>
          <div className="flex w-full items-center gap-2 md:w-80">
            <div className="relative w-full">
              <Search className="pointer-events-none absolute left-3 top-2.5 h-4 w-4 text-muted-foreground" />
              <Input
                placeholder="Search by borrower or ID…"
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                className="pl-9"
              />
            </div>
          </div>
        </div>

        {/* Status Filters */}
        <div className="mb-6 grid grid-cols-1 gap-3 sm:grid-cols-2 md:grid-cols-4">
          {(["All", "Approved", "Rejected", "On Hold"] as const).map((key) => (
            <Card
              key={key}
              onClick={() => setStatusFilter(key)}
              className={`cursor-pointer transition hover:shadow-md ${
                statusFilter === key ? "ring-2 ring-primary" : ""
              }`}
            >
              <CardHeader className="pb-2">
                <CardTitle className="text-base font-medium">{key}</CardTitle>
              </CardHeader>
              <CardContent className="pt-0">
                <div className="text-3xl font-semibold">{counts[key]}</div>
              </CardContent>
            </Card>
          ))}
        </div>

        {/* Table */}
        <div className="overflow-hidden rounded-2xl border bg-white shadow-sm">
          <table className="min-w-full table-fixed">
            <thead className="bg-slate-50 text-left text-sm text-slate-600">
              <tr>
                <th className="px-5 py-3 font-semibold">Loan ID</th>
                <th className="px-5 py-3 font-semibold">Borrower</th>
                <th className="px-5 py-3 font-semibold w-32">Amount</th>
                <th className="px-5 py-3 font-semibold w-24">APR</th>
                <th className="px-5 py-3 font-semibold w-36">Status</th>
                <th className="px-5 py-3 font-semibold w-40">Updated</th>
                <th className="px-5 py-3"></th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {filtered.map((loan) => (
                <tr key={loan.id} className="hover:bg-slate-50">
                  <td className="px-5 py-4 font-medium">{loan.id}</td>
                  <td className="px-5 py-4">
                    <div className="flex items-center gap-2">
                      <User2 className="h-4 w-4 text-muted-foreground" />
                      <span>{loan.borrower}</span>
                    </div>
                  </td>
                  <td className="px-5 py-4 font-medium tabular-nums">{formatINR(loan.amount)}</td>
                  <td className="px-5 py-4 tabular-nums">{loan.apr.toFixed(2)}%</td>
                  <td className="px-5 py-4"><StatusBadge status={loan.status} /></td>
                  <td className="px-5 py-4 text-sm text-muted-foreground">
                    <div className="flex items-center gap-2"><Calendar className="h-4 w-4" />{new Date(loan.updatedAt).toLocaleDateString()}</div>
                  </td>
                  <td className="px-5 py-3 text-right">
                    <Button size="sm" variant="ghost" className="group" onClick={() => setSelected(loan)}>
                      View <ChevronRight className="ml-1 h-4 w-4 transition group-hover:translate-x-0.5" />
                    </Button>
                  </td>
                </tr>
              ))}
              {filtered.length === 0 && (
                <tr>
                  <td colSpan={7} className="px-5 py-10 text-center text-sm text-muted-foreground">
                    No loans match your filters.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>

        {/* Detail Drawer */}
        <Sheet open={!!selected} onOpenChange={(open) => !open && setSelected(null)}>
          <SheetContent side="right" className="w-full max-w-xl p-0">
            {selected && (
              <div className="h-full overflow-y-auto">
                <div className="sticky top-0 z-10 border-b bg-white p-5">
                  <SheetHeader>
                    <SheetTitle className="flex items-center justify-between">
                      <span>Loan Details</span>
                      <StatusBadge status={selected.status} />
                    </SheetTitle>
                    <SheetDescription>#{selected.id} · Updated {new Date(selected.updatedAt).toLocaleDateString()}</SheetDescription>
                  </SheetHeader>
                </div>

                <div className="grid gap-4 p-5">
                  <Card>
                    <CardHeader>
                      <CardTitle className="text-lg">Summary</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-2">
                      <InfoRow label="Borrower" value={selected.borrower} icon={<User2 className="h-4 w-4" />} />
                      <Separator />
                      <InfoRow label="Amount" value={formatINR(selected.amount)} icon={<IndianRupee className="h-4 w-4" />} />
                      <Separator />
                      <InfoRow label="APR" value={`${selected.apr.toFixed(2)}%`} icon={<Percent className="h-4 w-4" />} />
                      <Separator />
                      <InfoRow label="Product" value={selected.product} />
                      <Separator />
                      <InfoRow label="Purpose" value={selected.purpose} />
                      <Separator />
                      <InfoRow label="Term" value={`${selected.termMonths ?? "—"} months`} />
                    </CardContent>
                  </Card>

                  <Card>
                    <CardHeader>
                      <CardTitle className="text-lg">Milestones</CardTitle>
                    </CardHeader>
                    <CardContent>
                      <ol className="relative ml-3 border-l pl-5">
                        <li className="mb-6">
                          <div className="absolute -left-[9px] top-1 h-2.5 w-2.5 rounded-full bg-slate-300" />
                          <p className="text-sm font-medium">Submitted</p>
                          <p className="text-xs text-muted-foreground">Application received</p>
                        </li>
                        <li className="mb-6">
                          <div className="absolute -left-[9px] top-1 h-2.5 w-2.5 rounded-full bg-slate-300" />
                          <p className="text-sm font-medium">Under Review</p>
                          <p className="text-xs text-muted-foreground">Credit & documents verified</p>
                        </li>
                        <li className="mb-2">
                          <div className={`absolute -left-[9px] top-1 h-2.5 w-2.5 rounded-full ${
                            selected.status === "Approved"
                              ? "bg-emerald-500"
                              : selected.status === "Rejected"
                              ? "bg-rose-500"
                              : "bg-amber-500"
                          }`} />
                          <p className="text-sm font-medium">{selected.status}</p>
                          <p className="text-xs text-muted-foreground">Final decision recorded</p>
                        </li>
                      </ol>
                    </CardContent>
                  </Card>

                  {selected.notes && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="text-lg">Notes</CardTitle>
                      </CardHeader>
                      <CardContent>
                        <p className="text-sm leading-relaxed text-slate-700">{selected.notes}</p>
                      </CardContent>
                    </Card>
                  )}
                </div>
              </div>
            )}
          </SheetContent>
        </Sheet>
      </div>
    </div>
  );
}
